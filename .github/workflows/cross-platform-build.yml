name: Buffer Overflow Test

on: [push, pull_request]

jobs:
  ubuntu-gcc:
    name: Ubuntu (GCC)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GCC
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - name: Compile without protection
        run: |
          g++ -g -fno-stack-protector -z execstack -no-pie -O0 -o overflow main.cpp
          echo "=== Running without protection (mode 3) ==="
          echo "3" | ./overflow || true

      - name: Compile with stack protector
        run: |
          g++ -fstack-protector-all -O0 -o overflow_protected main.cpp
          echo "=== Running with stack protector (mode 3) ==="
          echo "3" | ./overflow_protected || true

      - name: Compile with AddressSanitizer
        run: |
          g++ -fsanitize=address -g -O0 -o overflow_asan main.cpp
          echo "=== Running with AddressSanitizer (mode 3) ==="
          echo "3" | ./overflow_asan || true

  ubuntu-clang:
    name: Ubuntu (Clang)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y clang

      - name: Compile without protection
        run: |
          clang++ -g -fno-stack-protector -z execstack -no-pie -O0 -o overflow main.cpp
          echo "=== Running without protection (mode 3) ==="
          echo "3" | ./overflow || true

      - name: Compile with stack protector
        run: |
          clang++ -fstack-protector-all -O0 -o overflow_protected main.cpp
          echo "=== Running with stack protector (mode 3) ==="
          echo "3" | ./overflow_protected || true

      - name: Compile with AddressSanitizer
        run: |
          clang++ -fsanitize=address -g -O0 -o overflow_asan main.cpp
          echo "=== Running with AddressSanitizer (mode 3) ==="
          echo "3" | ./overflow_asan || true

  mac-gcc:
    name: macOS (GCC)
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GCC
        run: |
          brew install gcc

      - name: Compile without protection
        run: |
          g++-13 -g -fno-stack-protector -Wl,-no_pie -O0 -o overflow main.cpp
          echo "=== Running without protection (mode 3) ==="
          echo "3" | ./overflow || true

      - name: Compile with stack protector
        run: |
          g++-13 -fstack-protector-all -O0 -o overflow_protected main.cpp
          echo "=== Running with stack protector (mode 3) ==="
          echo "3" | ./overflow_protected || true

      - name: Compile with AddressSanitizer
        run: |
          g++ -fsanitize=address -g -O0 -o overflow_asan main.cpp
          echo "=== Running with AddressSanitizer (mode 3) ==="
          echo "3" | ./overflow_asan || true

